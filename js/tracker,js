// Ù†Ø¸Ø§Ù… ØªØªØ¨Ø¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
let userActions = [];
let sessionStartTime;
let pageViewCount = 0;

function startUserTracking() {
    console.log('ğŸ‘¤ Ø¨Ø¯Ø¡ ØªØªØ¨Ø¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…');
    sessionStartTime = Date.now();
    pageViewCount = 0;
    userActions = [];
    
    // ØªØªØ¨Ø¹ Ø§Ù„Ù†Ù‚Ø±Ø§Øª
    document.addEventListener('click', trackClick);
    
    // ØªØªØ¨Ø¹ Ø­Ø±ÙƒØ© Ø§Ù„Ù…Ø§ÙˆØ³
    document.addEventListener('mousemove', trackMouseMovement);
    
    // ØªØªØ¨Ø¹ Ø§Ù„Ù„Ù…Ø³ (Ù„Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ù„ÙˆØ­ÙŠØ© ÙˆØ§Ù„Ù‡ÙˆØ§ØªÙ)
    document.addEventListener('touchstart', trackTouch);
    document.addEventListener('touchend', trackTouchEnd);
    
    // ØªØªØ¨Ø¹ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù†Øµ
    document.addEventListener('input', trackTextInput);
    
    // ØªØ³Ø¬ÙŠÙ„ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¬Ù„Ø³Ø©
    sendTelegramData('session_started', {
        sessionId: getSessionId(),
        startTime: new Date().toISOString(),
        referrer: document.referrer || 'Ù…Ø¨Ø§Ø´Ø±'
    });
    
    console.log('âœ… ØªÙ… Ø¨Ø¯Ø¡ ØªØªØ¨Ø¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…');
}

function trackPageView(pageId) {
    console.log(`ğŸ“Š ØªØªØ¨Ø¹ Ù…Ø´Ø§Ù‡Ø¯ Ø§Ù„ØµÙØ­Ø©: ${pageId}`);
    
    pageViewCount++;
    const pageData = {
        page: pageId,
        timestamp: new Date().toISOString(),
        timeOnPreviousPage: calculateTimeOnPage(),
        scrollPosition: window.pageYOffset,
        sessionDuration: getSessionDuration(),
        pageViewNumber: pageViewCount
    };
    
    userActions.push({
        type: 'page_view',
        data: pageData,
        timestamp: new Date().toISOString()
    });
    
    // Ø¥Ø±Ø³Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„ØµÙØ­Ø©
    sendTelegramData('page_view', pageData);
}

function trackButtonClick(buttonId) {
    console.log(`ğŸ–±ï¸ ØªØªØ¨Ø¹ Ù†Ù‚Ø± Ø²Ø±: ${buttonId}`);
    
    const clickData = {
        buttonId: buttonId,
        page: getCurrentPageId(),
        timestamp: new Date().toISOString(),
        sessionDuration: getSessionDuration()
    };
    
    userActions.push({
        type: 'button_click',
        data: clickData,
        timestamp: new Date().toISOString()
    });
    
    sendTelegramData('specific_button_click', clickData);
}

function trackClick(event) {
    const target = event.target;
    const clickData = {
        element: target.tagName.toLowerCase(),
        id: target.id || 'no-id',
        class: target.className || 'no-class',
        text: target.textContent?.trim().substring(0, 50) || 'no-text',
        x: event.clientX,
        y: event.clientY,
        page: getCurrentPageId(),
        timestamp: new Date().toISOString()
    };
    
    userActions.push({
        type: 'click',
        data: clickData,
        timestamp: new Date().toISOString()
    });
    
    // Ø¥Ø±Ø³Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ù‚Ø± Ø§Ù„Ù…Ù‡Ù…Ø© ÙÙ‚Ø·
    if (target.closest('button') || target.closest('a') || target.id.includes('btn')) {
        sendTelegramData('button_click', clickData);
    }
}

function trackMouseMovement(event) {
    // ØªÙ‚Ù„ÙŠÙ„ ÙƒÙ…ÙŠØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª - ØªØ³Ø¬ÙŠÙ„ ÙƒÙ„ Ø­Ø±ÙƒØ© Ø¹Ø´ÙˆØ§Ø¦ÙŠØ© ÙÙ‚Ø·
    if (Math.random() < 0.01) { // 1% Ù…Ù† Ø­Ø±ÙƒØ§Øª Ø§Ù„Ù…Ø§ÙˆØ³ ÙÙ‚Ø·
        const mouseData = {
            x: event.clientX,
            y: event.clientY,
            page: getCurrentPageId(),
            timestamp: new Date().toISOString()
        };
        
        userActions.push({
            type: 'mouse_move',
            data: mouseData,
            timestamp: new Date().toISOString()
        });
    }
}

function trackTouch(event) {
    if (event.touches.length > 0) {
        const touchData = {
            touches: event.touches.length,
            x: event.touches[0].clientX,
            y: event.touches[0].clientY,
            page: getCurrentPageId(),
            timestamp: new Date().toISOString()
        };
        
        userActions.push({
            type: 'touch_start',
            data: touchData,
            timestamp: new Date().toISOString()
        });
        
        sendTelegramData('touch_event', touchData);
    }
}

function trackTouchEnd(event) {
    const touchData = {
        type: 'touch_end',
        page: getCurrentPageId(),
        timestamp: new Date().toISOString()
    };
    
    userActions.push({
        type: 'touch_end',
        data: touchData,
        timestamp: new Date().toISOString()
    });
}

function trackTextInput(event) {
    const target = event.target;
    if (target.tagName.toLowerCase() === 'input') {
        const inputData = {
            fieldId: target.id || 'unknown',
            fieldType: target.type,
            valueLength: target.value.length,
            page: getCurrentPageId(),
            timestamp: new Date().toISOString()
        };
        
        userActions.push({
            type: 'text_input',
            data: inputData,
            timestamp: new Date().toISOString()
        });
    }
}

// Ø¹Ù†Ø¯ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØµÙØ­Ø©
window.addEventListener('beforeunload', function() {
    const sessionData = {
        sessionId: getSessionId(),
        duration: getSessionDuration(),
        pageViews: pageViewCount,
        actionsCount: userActions.length,
        endTime: new Date().toISOString()
    };
    
    // Ø¥Ø±Ø³Ø§Ù„ Ù…Ù„Ø®Øµ Ø§Ù„Ø¬Ù„Ø³Ø©
    sendTelegramData('session_ended', sessionData);
    
    // Ø¥Ø±Ø³Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ù…Ù‡Ù…Ø©
    const importantActions = userActions.filter(action => 
        ['page_view', 'button_click', 'touch_event'].includes(action.type)
    );
    
    if (importantActions.length > 0) {
        sendTelegramData('user_actions_summary', {
            sessionId: getSessionId(),
            actions: importantActions.slice(-10) // Ø¢Ø®Ø± 10 Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª ÙÙ‚Ø·
        });
    }
    
    console.log('ğŸ‘‹ Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¬Ù„Ø³Ø©:', sessionData);
});

// ÙˆØ¸Ø§Ø¦Ù Ù…Ø³Ø§Ø¹Ø¯Ø©
function getCurrentPageId() {
    const activePage = document.querySelector('.page.active');
    return activePage ? activePage.id : 'unknown';
}

function calculateTimeOnPage() {
    const lastPageView = userActions
        .filter(action => action.type === 'page_view')
        .pop();
    
    if (lastPageView) {
        return Date.now() - new Date(lastPageView.timestamp).getTime();
    }
    return 0;
}

function getSessionDuration() {
    return Date.now() - sessionStartTime;
}

// Ø¯Ø§Ù„Ø© Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ø±Ù Ø§Ù„Ø¬Ù„Ø³Ø©
function getSessionId() {
    if (!sessionStorage.getItem('survey_session_id')) {
        const sessionId = 'sess_' + Math.random().toString(36).substr(2, 9);
        sessionStorage.setItem('survey_session_id', sessionId);
        console.log(`ğŸ†” Ù…Ø¹Ø±Ù Ø§Ù„Ø¬Ù„Ø³Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯: ${sessionId}`);
    }
    return sessionStorage.getItem('survey_session_id');
}

// Ø¯Ø§Ù„Ø© Ù„Ø¨Ø¯Ø¡ Ø§Ù„ØªØªØ¨Ø¹ Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
        console.log('ğŸ“Š Ø¬Ø§Ù‡Ø² Ù„Ø¨Ø¯Ø¡ Ø§Ù„ØªØªØ¨Ø¹');
    });
} else {
    console.log('ğŸ“Š Ø§Ù„ØµÙØ­Ø© Ù…Ø­Ù…Ù„Ø© Ø¨Ø§Ù„ÙØ¹Ù„ØŒ Ø¬Ø§Ù‡Ø² Ù„Ù„ØªØªØ¨Ø¹');
}